<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ ğŸ‘®â€â™‚ï¸ğŸ“¦</title>
    
    <!-- Firebase & QRCode -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1e3a8a; /* ÙƒØ­Ù„ÙŠ Ø´Ø±Ø·Ø© */
            --secondary: #3b82f6; 
            --accent: #f59e0b; /* Ø°Ù‡Ø¨ÙŠ/Ø£ØµÙØ± */
            --danger: #ef4444; 
            --success: #10b981;
            --text-light: #f8fafc;
            --bg-dark: rgba(15, 23, 42, 0.65); /* ØªÙ… ØªÙØªÙŠØ­ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¸Ù‡Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØ¶ÙˆØ­ */
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #0f172a;
            
            /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙŠØºØ© Ù‡Ù†Ø§ Ø¥Ù„Ù‰ png Ù„ØªØ·Ø§Ø¨Ù‚ ØµÙˆØ±ØªÙƒ */
            background-image: url('jmarek.png'); 
            background-size: cover;
            background-position: center;
        }

        /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        body::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark); z-index: -1;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: flex-start; position: absolute; top: 0; left: 0; overflow-y: auto; padding: 20px; z-index: 10; }
        .active { display: flex; }

        .glass-panel {
            background: rgba(0, 0, 0, 0.6); /* ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¨Ø±Ø² ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ÙØ§ØªØ­Ø© */
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            padding: 20px; width: 100%; max-width: 600px; text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold; border-radius: 12px;
            cursor: pointer; margin: 10px 5px; width: 90%; max-width: 300px;
            transition: transform 0.1s, filter 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-family: 'Tajawal';
        }
        .btn:active { transform: translateY(3px); filter: brightness(1.2); }
        .btn-gold { background: linear-gradient(135deg, #f59e0b, #d97706); color: black; }
        .btn-green { background: linear-gradient(135deg, var(--success), #059669); }
        .btn-red { background: linear-gradient(135deg, var(--danger), #b91c1c); }

        /* --- Landing & TV --- */
        #qr-container { background: white; padding: 15px; border-radius: 15px; display: inline-block; margin-bottom: 20px; }
        .player-badge { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 50px; font-weight: bold; margin: 5px; display: inline-block; font-size:1.1rem; }
        
        .scoreboard { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .score-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent); font-size:1.2rem; align-items: center;}
        
        /* --- Player Goods --- */
        .goods-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin-top: 15px; }
        .good-item { 
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 15px 5px; font-weight: bold; cursor: pointer;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .good-item.selected { background: var(--primary); border-color: white; transform: scale(0.95); }
        .good-item.illegal { border-color: rgba(239, 68, 68, 0.5); }
        .good-item.illegal.selected { background: var(--danger); border-color: white; }
        
        .pts-badge { font-size: 0.8rem; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; margin-top: 5px; }

        /* --- Officer Dashboard --- */
        .target-card { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #ffffff22; }
        .target-actions { display: flex; gap: 10px; margin-top: 10px; }
        .target-actions button { margin: 0; flex: 1; padding: 10px; font-size: 1rem; }
        
        .status-tag { padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; font-weight: bold; }
        .tag-passed { background: var(--success); }
        .tag-inspected { background: var(--primary); }

        /* Modal for results and QR */
        #result-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; flex-direction: column; text-align: center; padding: 20px;}
        .result-content { background: #1e293b; padding: 30px; border-radius: 20px; border: 2px solid var(--gold); max-width: 500px; width: 100%; }

        #tv-qr-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center; flex-direction: column; text-align: center; padding: 20px;}
        .qr-modal-content { background: #1e293b; padding: 40px; border-radius: 20px; border: 2px solid var(--primary); display: flex; flex-direction: column; align-items: center;}

        input { width: 100%; padding: 15px; border-radius: 12px; border: none; text-align: center; font-size: 1.2rem; font-family: 'Tajawal'; margin-bottom: 15px; }
        
        #officer-announce { font-size: 3rem; color: var(--danger); font-weight: 900; animation: pulse 1s infinite alternate; text-shadow: 0 0 20px red; margin: 20px 0;}
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

    </style>
</head>
<body>

    <!-- Ø±Ø¨Ø· Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ Description.mp3 -->
    <audio id="expl-audio" src="Description.mp3"></audio>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="result-modal">
        <div class="result-content">
            <h1 id="rm-title" style="font-size:3rem; margin:0 0 10px 0;">...</h1>
            <p id="rm-desc" style="font-size:1.5rem; color:#ccc;"></p>
            <div id="rm-items" style="font-size:1.2rem; margin:20px 0; color:var(--accent);"></div>
            <button class="btn btn-gold" onclick="document.getElementById('result-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
    <div id="tv-qr-modal">
        <div class="qr-modal-content">
            <h2 style="margin-top:0; color:white;">Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h2>
            <div id="tv-qr-img-large" style="background:white; padding:15px; border-radius:15px; margin-bottom:20px;"></div>
            <button class="btn btn-red" onclick="document.getElementById('tv-qr-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚ âŒ</button>
        </div>
    </div>

    <!-- ==================== 1. Landing Screen ==================== -->
    <div id="scr-landing" class="screen active" style="justify-content:flex-end; padding-bottom:50px;">
        <div style="background:rgba(0,0,0,0.8); padding:20px; border-radius:20px; margin-bottom:auto; margin-top:20px; text-align:center;">
            <h1 style="font-size:4rem; margin:0; color:white; text-shadow:0 0 20px black;">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ ğŸ‘®â€â™‚ï¸</h1>
            <p style="font-size:1.5rem; color:#ccc; margin:5px 0;">Ø§Ù„ØªÙØªÙŠØ´ØŒ Ø§Ù„ØªÙ‡Ø±ÙŠØ¨ØŒ ÙˆØ§Ù„Ù…ÙƒØ§Ø³Ø¨!</p>
        </div>
        <button class="btn btn-gold" style="font-size:1.5rem; padding:20px;" onclick="createGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸš€</button>
    </div>

    <!-- ==================== 2. Host (TV) Screen ==================== -->
    <div id="scr-tv" class="screen">
        
        <!-- Ø²Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ø¦Ù… ÙÙˆÙ‚ ÙŠÙ…ÙŠÙ† -->
        <button class="btn btn-gold" style="position:absolute; top:20px; right:20px; width:auto; margin:0; z-index:100; font-size:1.1rem; padding:10px 20px;" onclick="document.getElementById('tv-qr-modal').style.display='flex'">ğŸ“± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Lobby) -->
        <div id="tv-lobby" class="glass-panel" style="max-width:800px; margin-top:60px;">
            <h2>Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <div id="qr-container"></div>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
                <button class="btn" style="width:auto; margin:0;" onclick="playAudio()">ğŸ§ Ø´Ø±Ø­ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                <button class="btn btn-gold" style="width:auto; margin:0;" onclick="startGame()" id="btn-real-start" style="display:none;">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</button>
            </div>
            
            <h3 style="margin-top:30px; border-top:1px solid #555; padding-top:15px;">Ø§Ù„Ù…Ø³Ø§ÙØ±ÙˆÙ† (<span id="tv-player-count">0</span>)</h3>
            <div id="tv-players-list" style="margin-bottom:20px;"></div>
        </div>

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div id="tv-game" style="display:none; width:100%; max-width:800px; margin-top:60px;">
            <div class="glass-panel">
                <h3 id="tv-status-msg" style="color:#aaa; margin:0;">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div id="officer-announce">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ: ÙÙ„Ø§Ù†</div>
            </div>

            <div class="scoreboard" id="tv-scoreboard"></div>
            
            <button class="btn btn-gold" id="btn-next-round" style="display:none; margin-top:30px;" onclick="nextRound()">ğŸ”„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ)</button>
        </div>
    </div>

    <!-- ==================== 3. Player Screen ==================== -->
    <div id="scr-player" class="screen">
        
        <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="p-login" class="glass-panel">
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø­Ø¯ÙˆØ¯ ğŸ›‚</h2>
            <input type="text" id="p-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="12">
            <button class="btn btn-green" onclick="joinGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>

        <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
        <div id="p-dash" style="display:none; width:100%; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.8); padding:10px 20px; border-radius:15px; margin-bottom:15px;">
                <span id="p-name-disp" style="font-weight:bold; font-size:1.2rem;">...</span>
                <span style="color:var(--success); font-weight:bold; font-size:1.2rem;"><span id="p-money-disp">100</span> Ø±ÙŠØ§Ù„ ğŸ’°</span>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
            <div id="p-wait" class="glass-panel" style="display:none;">
                <h1 style="font-size:4rem; margin:10px;">â³</h1>
                <h2 id="p-wait-msg">Ø§Ù†ØªØ¸Ø±...</h2>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ± (Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹) -->
            <div id="p-smuggler" class="glass-panel" style="display:none; padding:15px;">
                <h3 style="margin:0 0 5px 0; color:var(--accent);">Ø¬Ù‡Ø² Ø­Ù‚ÙŠØ¨ØªÙƒ ğŸ§³</h3>
                <p style="font-size:0.9rem; color:#aaa; margin:0 0 15px 0;">Ø§Ø®ØªØ± 5 Ø£ØºØ±Ø§Ø¶ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ø¨ÙˆØ± Ø¨Ù‡Ø§</p>
                
                <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">Ø§Ø®ØªØ±Øª: <span id="p-sel-count" style="color:var(--gold)">0</span> / 5</div>
                
                <div id="p-goods-grid" class="goods-grid"></div>
                <button class="btn btn-green" style="width:100%; margin-top:20px;" onclick="submitBag()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© ÙˆØ§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„ØªÙØªÙŠØ´</button>
            </div>

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ (ØªÙØªÙŠØ´) -->
            <div id="p-officer" style="display:none; width:100%;">
                <div class="glass-panel" style="margin-bottom:15px; background:rgba(220, 38, 38, 0.4); border-color:var(--danger);">
                    <h2 style="margin:0; color:var(--danger);">ğŸ‘®â€â™‚ï¸ Ø£Ù†Øª Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ!</h2>
                    <p style="margin:5px 0 0 0;">Ù‚Ø±Ø± Ù…Ù† ÙŠÙ…Ø± ÙˆÙ…Ù† ÙŠØªÙØªØ´</p>
                </div>
                <div id="p-targets-list"></div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // =====================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        // =====================================
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('scan') === '1') {
            localStorage.removeItem('jam_uid'); 
            const newUrl = window.location.href.replace('&scan=1', '').replace('?scan=1', '');
            window.history.replaceState({}, document.title, newUrl);
        }

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDh4v9gRCICA_XRCJXsDpbtCySYAoFsfhk",
            authDomain: "bagera-word.firebaseapp.com",
            databaseURL: "https://bagera-word-default-rtdb.firebaseio.com",
            projectId: "bagera-word",
            storageBucket: "bagera-word.firebasestorage.app",
            messagingSenderId: "53001885470",
            appId: "1:53001885470:web:c6649f9f259824f747db0f"
        };
        try { if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig); else firebase.app(); } catch(e) {}
        const db = firebase.database();

        // --- Game Data ---
        const GOODS = [
            { id: 'l1', name: 'ğŸ§€ Ø¬Ø¨Ù†', type: 'legal', pts: 5 },
            { id: 'l2', name: 'ğŸ¥› Ø­Ù„ÙŠØ¨', type: 'legal', pts: 5 },
            { id: 'l3', name: 'ğŸ¥Ÿ ÙŠØºÙ…Ø´', type: 'legal', pts: 5 },
            { id: 'l4', name: 'ğŸ¥Ÿ Ù…Ù†ØªÙˆ', type: 'legal', pts: 5 },
            { id: 'l5', name: 'ğŸª Ø­Ù„Ø§ Ø§Ù„Ø§ÙˆØ±ÙŠÙˆ', type: 'legal', pts: 5 },
            { id: 'l6', name: 'ğŸ— Ø¨Ø±ÙˆØ³Øª', type: 'legal', pts: 5 },
            { id: 'i1', name: 'ğŸ· Ø®Ù…Ø±', type: 'illegal', pts: 10 },
            { id: 'i2', name: 'ğŸ¥“ Ù„Ø­Ù… Ø®Ù†Ø²ÙŠØ±', type: 'illegal', pts: 10 },
            { id: 'i3', name: 'ğŸ«– Ø´Ø§Ù‡ÙŠ Ø­Ù„ÙŠØ¨ Ø¹Ù…ÙˆØ±ÙŠ', type: 'illegal', pts: 10 },
            { id: 'i4', name: 'ğŸ¥ª Ø³Ø§Ù†Ø¯ÙˆÙŠØ´ Ù…Ù† ÙƒÙŠ Ø¨ÙŠ Ø§Ø³', type: 'illegal', pts: 10 },
            { id: 'i5', name: 'ğŸ”ª Ø³ÙƒÙŠÙ†', type: 'illegal', pts: 10 },
            { id: 'i6', name: 'ğŸ”« Ù…Ø³Ø¯Ø³', type: 'illegal', pts: 10 }
        ];

        let roomId = new URLSearchParams(window.location.search).get('room');
        const role = new URLSearchParams(window.location.search).get('role');
        
        let myId = localStorage.getItem('jam_uid') || 'u_'+Date.now();
        localStorage.setItem('jam_uid', myId);
        let myName = '';
        let myBag = [];

        function playAudio() { 
            const audio = document.getElementById('expl-audio');
            if(audio.paused) {
                audio.play();
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        // --- Routing ---
        window.onload = function() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(role === 'player') { 
                document.getElementById('scr-player').classList.add('active'); 
                initPlayer(); 
            } else if(roomId && new URLSearchParams(window.location.search).get('mode') === 'tv') { 
                document.getElementById('scr-tv').classList.add('active'); 
                initTV(); 
            } else if (roomId) {
                window.location.href = `?room=${roomId}&role=player&scan=1`;
            } else { 
                document.getElementById('scr-landing').classList.add('active'); 
            }
        };

        // --- Host/TV Actions ---
        function createGame() {
            roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            window.history.pushState({}, '', `?room=${roomId}`);
            db.ref(`jamarek/${roomId}`).set({ state: 'lobby', officerIndex: 0, round: 1 });
            window.location.href = `?room=${roomId}&mode=tv`;
        }

        function generateQR() {
            const base = window.location.href.split('?')[0];
            const pUrl = base + `?room=${roomId}&role=player&scan=1`;
            
            const c = document.getElementById('qr-container');
            c.innerHTML = '';
            new QRCode(c, { text: pUrl, width: 250, height: 250, colorDark: "#1e3a8a" });

            const modalQr = document.getElementById('tv-qr-img-large');
            if(modalQr) {
                modalQr.innerHTML = '';
                new QRCode(modalQr, { text: pUrl, width: 300, height: 300, colorDark: "#1e3a8a" });
            }
        }

        function startGame() {
            db.ref(`jamarek/${roomId}`).update({ state: 'selecting' });
        }

        function nextRound() {
            db.ref(`jamarek/${roomId}`).once('value', snap => {
                const data = snap.val();
                const pKeys = Object.keys(data.players).sort();
                
                let updates = {};
                updates['state'] = 'selecting';
                updates['officerIndex'] = data.officerIndex + 1; 
                updates['round'] = data.round + 1;
                
                pKeys.forEach(k => {
                    updates[`players/${k}/bag`] = null;
                    updates[`players/${k}/hasSelected`] = false;
                    updates[`players/${k}/status`] = 'waiting';
                });
                
                db.ref(`jamarek/${roomId}`).update(updates);
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø£Ù…ÙˆØ§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ù„Ù…Ø¶ÙŠÙ)
        window.editPlayerMoney = function(playerId, currentMoney) {
            const newVal = prompt(`Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ùˆ: ${currentMoney} Ø±ÙŠØ§Ù„\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡ (Ù„Ù„ØªØ¹ÙˆÙŠØ¶ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„):`, currentMoney);
            
            if(newVal !== null && newVal.trim() !== '' && !isNaN(parseInt(newVal))) {
                db.ref(`jamarek/${roomId}/players/${playerId}/money`).set(parseInt(newVal));
            }
        }

        // --- TV Logic ---
        function initTV() {
            generateQR();
            db.ref(`jamarek/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                const players = data.players || {};
                const pKeys = Object.keys(players).sort();
                
                let officerId = null;
                let officerName = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                if(pKeys.length > 0) {
                    officerId = pKeys[data.officerIndex % pKeys.length];
                    officerName = players[officerId].name;
                }

                if(data.state === 'lobby') {
                    document.getElementById('tv-lobby').style.display = 'block';
                    document.getElementById('tv-game').style.display = 'none';
                    document.getElementById('tv-player-count').innerText = pKeys.length;
                    document.getElementById('tv-players-list').innerHTML = Object.values(players).map(p => `<span class="player-badge">ğŸ‘¤ ${p.name}</span>`).join('');
                    if(pKeys.length >= 2) document.getElementById('btn-real-start').style.display = 'inline-block';
                } 
                else {
                    document.getElementById('tv-lobby').style.display = 'none';
                    document.getElementById('tv-game').style.display = 'flex';
                    document.getElementById('tv-game').style.flexDirection = 'column';
                    document.getElementById('tv-game').style.alignItems = 'center';

                    document.getElementById('officer-announce').innerText = `ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ: ${officerName}`;
                    
                    if(data.state === 'selecting') {
                        document.getElementById('tv-status-msg').innerText = "Ø§Ù„Ù…Ø³Ø§ÙØ±ÙˆÙ† ÙŠØ¬Ù‡Ø²ÙˆÙ† Ø­Ù‚Ø§Ø¦Ø¨Ù‡Ù… ğŸ§³...";
                        document.getElementById('btn-next-round').style.display = 'none';
                    } else if (data.state === 'inspecting') {
                        document.getElementById('tv-status-msg').innerText = "Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ÙŠÙØªØ´ Ø§Ù„Ø¢Ù† ğŸ”!";
                        
                        const allDone = pKeys.every(k => k === officerId || players[k].status !== 'waiting');
                        if(allDone) document.getElementById('btn-next-round').style.display = 'block';
                        else document.getElementById('btn-next-round').style.display = 'none';
                    }

                    const board = document.getElementById('tv-scoreboard');
                    board.innerHTML = pKeys.map(k => {
                        const p = players[k];
                        const isOff = k === officerId;
                        let statusIcon = '';
                        if(!isOff) {
                            if(p.status === 'passed') statusIcon = 'âœ… Ø¹Ø¨Ø±';
                            else if(p.status === 'inspected') statusIcon = 'ğŸ” ÙÙØªÙØ´';
                            else statusIcon = 'â³ ÙŠÙ†ØªØ¸Ø±';
                        }
                        
                        return `
                        <div class="score-row">
                            <span style="font-weight:bold; color:${isOff ? 'var(--danger)' : 'white'};">
                                ${isOff ? 'ğŸ‘®â€â™‚ï¸' : 'ğŸ‘¤'} ${p.name}
                            </span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span style="font-size:0.9rem; color:#aaa;">${statusIcon}</span>
                                <span style="color:var(--success); font-weight:900;">${p.money} Ø±ÙŠØ§Ù„</span>
                                <button onclick="editPlayerMoney('${k}', ${p.money})" style="background:transparent; border:none; cursor:pointer; font-size:1.3rem; margin-right:10px; filter:grayscale(0.5); transition:0.2s;" onmouseover="this.style.filter='grayscale(0)'" onmouseout="this.style.filter='grayscale(0.5)'" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯">âœï¸</button>
                            </div>
                        </div>`;
                    }).join('');
                }
            });
        }

        // --- Player Logic ---
        function initPlayer() {
            db.ref(`jamarek/${roomId}/players/${myId}`).once('value', snap => {
                if(snap.exists()) {
                    myName = snap.val().name;
                    showPlayerDash();
                }
            });

            const grid = document.getElementById('p-goods-grid');
            GOODS.forEach(g => {
                const el = document.createElement('div');
                el.className = `good-item ${g.type === 'illegal' ? 'illegal' : ''}`;
                el.innerHTML = `<span>${g.name}</span><span class="pts-badge">${g.pts} Ø±ÙŠØ§Ù„</span>`;
                el.onclick = () => toggleGood(g, el);
                grid.appendChild(el);
            });
        }

        function joinGame() {
            const n = document.getElementById('p-name').value.trim();
            if(!n) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
            myName = n;
            db.ref(`jamarek/${roomId}/players/${myId}`).set({
                name: myName,
                money: 100, 
                status: 'waiting',
                hasSelected: false
            });
            showPlayerDash();
        }

        function showPlayerDash() {
            document.getElementById('p-login').style.display = 'none';
            document.getElementById('p-dash').style.display = 'flex';
            document.getElementById('p-dash').style.flexDirection = 'column';
            document.getElementById('p-name-disp').innerText = myName;
            
            db.ref(`jamarek/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data || !data.players || !data.players[myId]) return;

                const me = data.players[myId];
                document.getElementById('p-money-disp').innerText = me.money;

                const pKeys = Object.keys(data.players).sort();
                const officerId = pKeys[data.officerIndex % pKeys.length];
                const amIOfficer = (myId === officerId);

                ['p-wait', 'p-smuggler', 'p-officer'].forEach(id => document.getElementById(id).style.display = 'none');

                if(data.state === 'lobby') {
                    document.getElementById('p-wait').style.display = 'block';
                    document.getElementById('p-wait-msg').innerText = "Ø§Ù†ØªØ¸Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†...";
                }
                else if(data.state === 'selecting') {
                    if(amIOfficer) {
                        document.getElementById('p-wait').style.display = 'block';
                        document.getElementById('p-wait-msg').innerText = "Ø£Ù†Øª Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ! Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ù‡Ø±Ø¨ÙŠÙ† ÙŠØ¬Ù‡Ø²ÙˆÙ† Ø­Ù‚Ø§Ø¦Ø¨Ù‡Ù… ğŸ‘®â€â™‚ï¸";
                    } else {
                        if(me.hasSelected) {
                            document.getElementById('p-wait').style.display = 'block';
                            document.getElementById('p-wait-msg').innerText = "ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©! Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªÙØªÙŠØ´...";
                        } else {
                            document.getElementById('p-smuggler').style.display = 'block';
                            myBag = []; 
                            updateBagCount();
                            document.querySelectorAll('.good-item').forEach(el => el.classList.remove('selected'));
                        }
                    }
                }
                else if(data.state === 'inspecting') {
                    if(amIOfficer) {
                        document.getElementById('p-officer').style.display = 'block';
                        renderOfficerTargets(data.players, myId);
                    } else {
                        document.getElementById('p-wait').style.display = 'block';
                        if(me.status === 'passed') document.getElementById('p-wait-msg').innerHTML = "<span style='color:var(--success)'>âœ… Ù…Ø±ÙŠØª Ø¨Ø³Ù„Ø§Ù…!</span>";
                        else if(me.status === 'inspected') document.getElementById('p-wait-msg').innerHTML = "<span style='color:var(--primary)'>ØªÙ… ØªÙØªÙŠØ´Ùƒ ğŸ” Ø§Ù†Ø¸Ø± Ù„Ù„Ø´Ø§Ø´Ø©!</span>";
                        else document.getElementById('p-wait-msg').innerText = "Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ÙŠÙØªØ´ Ø§Ù„Ø¢Ù†... Ø§Ø¯Ø¹ Ø±Ø¨Ùƒ ğŸ¤²";
                    }
                }
            });
        }

        // Smuggler Actions
        function toggleGood(item, el) {
            const idx = myBag.findIndex(i => i.id === item.id);
            if(idx > -1) {
                myBag.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                if(myBag.length >= 5) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ø£ØºØ±Ø§Ø¶!");
                myBag.push(item);
                el.classList.add('selected');
            }
            updateBagCount();
        }

        function updateBagCount() {
            document.getElementById('p-sel-count').innerText = myBag.length;
        }

        function submitBag() {
            db.ref(`jamarek/${roomId}/players/${myId}`).update({
                bag: myBag,
                hasSelected: true
            });

            db.ref(`jamarek/${roomId}`).once('value', snap => {
                const data = snap.val();
                const pKeys = Object.keys(data.players).sort();
                const officerId = pKeys[data.officerIndex % pKeys.length];
                
                let allReady = true;
                Object.keys(data.players).forEach(k => {
                    if(k !== officerId && !data.players[k].hasSelected) allReady = false;
                });

                if(allReady) {
                    db.ref(`jamarek/${roomId}`).update({ state: 'inspecting' });
                }
            });
        }

        // Officer Actions
        function renderOfficerTargets(players, offId) {
            const list = document.getElementById('p-targets-list');
            list.innerHTML = '';
            
            Object.keys(players).forEach(pid => {
                if(pid === offId) return;
                const p = players[pid];
                
                let btnHtml = '';
                if(p.status === 'waiting') {
                    btnHtml = `
                    <div class="target-actions">
                        <button class="btn btn-red" onclick="processPlayer('${pid}', true)">ØªÙØªÙŠØ´ ğŸ”</button>
                        <button class="btn btn-green" onclick="processPlayer('${pid}', false)">ØªÙ…Ø´ÙŠØ© ğŸ‘‹</button>
                    </div>`;
                } else {
                    const tagClass = p.status === 'passed' ? 'tag-passed' : 'tag-inspected';
                    const tagText = p.status === 'passed' ? 'Ø¹Ø¨Ø±' : 'ÙÙØªÙØ´';
                    btnHtml = `<div style="text-align:left; margin-top:10px;"><span class="status-tag ${tagClass}">${tagText}</span></div>`;
                }

                list.innerHTML += `
                <div class="target-card">
                    <h3 style="margin:0; color:var(--gold);">ğŸ‘¤ ${p.name}</h3>
                    ${btnHtml}
                </div>`;
            });
        }

        function processPlayer(targetId, inspect) {
            db.ref(`jamarek/${roomId}/players`).once('value', snap => {
                const players = snap.val();
                const target = players[targetId];
                const officer = players[myId];
                
                const bag = target.bag || [];
                let legalVal = 0;
                let illegalVal = 0;
                let bagNames = [];
                
                bag.forEach(i => {
                    bagNames.push(i.name);
                    if(i.type === 'legal') legalVal += i.pts;
                    else illegalVal += i.pts;
                });

                const totalBagVal = legalVal + illegalVal;
                
                let updates = {};
                let resultTitle = "";
                let resultDesc = "";

                if(!inspect) {
                    // ØªÙ…Ø´ÙŠØ©
                    updates[`${targetId}/money`] = target.money + totalBagVal;
                    updates[`${targetId}/status`] = 'passed';
                    resultTitle = `<span style='color:var(--success)'>ØªÙ…Ø´ÙŠØ© Ù†Ø§Ø¬Ø­Ø© âœ…</span>`;
                    resultDesc = `Ø¹Ø¨Ø± ${target.name} Ø¨Ø³Ù„Ø§Ù… ÙˆÙƒØ³Ø¨ ${totalBagVal} Ø±ÙŠØ§Ù„!`;
                } else {
                    updates[`${targetId}/status`] = 'inspected';
                    
                    if(illegalVal === 0) {
                        // ØªÙØªÙŠØ´ Ø³Ù„ÙŠÙ… (Ø¸Ø§Ù„Ù…)
                        updates[`${myId}/money`] = officer.money - legalVal;
                        updates[`${targetId}/money`] = target.money + legalVal;
                        resultTitle = `<span style='color:var(--primary)'>ØªÙØªÙŠØ´ Ø¸Ø§Ù„Ù…! ğŸ¤¦â€â™‚ï¸</span>`;
                        resultDesc = `Ø­Ù‚ÙŠØ¨Ø© ${target.name} Ù†Ø¸ÙŠÙØ©! Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ Ø¯ÙØ¹ ØªØ¹ÙˆÙŠØ¶ ${legalVal} Ø±ÙŠØ§Ù„ Ù„Ù„Ù…Ø³Ø§ÙØ±.`;
                    } else {
                        // ÙƒÙØ´ Ù…Ù…Ù†ÙˆØ¹Ø§Øª
                        updates[`${myId}/money`] = officer.money + totalBagVal;
                        updates[`${targetId}/money`] = target.money - totalBagVal;
                        resultTitle = `<span style='color:var(--danger)'>ÙƒÙØ´ Ù…Ù…Ù†ÙˆØ¹Ø§Øª! ğŸš¨</span>`;
                        resultDesc = `ØªÙ… Ø§Ù„Ù‚Ø¨Ø¶ Ø¹Ù„Ù‰ ${target.name}! Ø¯ÙØ¹ ØºØ±Ø§Ù…Ø© ${totalBagVal} Ø±ÙŠØ§Ù„ Ù„Ù„Ø¬Ù…Ø±ÙƒÙŠ.`;
                    }
                }

                db.ref(`jamarek/${roomId}/players`).update(updates);
                
                db.ref(`jamarek/${roomId}/latestResult`).set({
                    t: Date.now(),
                    title: resultTitle,
                    desc: resultDesc,
                    items: inspect ? `Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©: ${bagNames.join(' ØŒ ')}` : ''
                });
            });
        }

        // Global Modal Listener
        db.ref(`jamarek/${roomId}/latestResult`).on('value', snap => {
            const res = snap.val();
            if(res && (Date.now() - res.t < 10000)) { 
                document.getElementById('rm-title').innerHTML = res.title;
                document.getElementById('rm-desc').innerHTML = res.desc;
                document.getElementById('rm-items').innerHTML = res.items;
                document.getElementById('result-modal').style.display = 'flex';
            }
        });

    </script>
</body>
</html>
