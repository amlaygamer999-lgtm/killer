<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ù…Ø§Ø±Ùƒ ğŸ‘®â€â™‚ï¸ğŸ“¦</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #111827;
            --primary: #f59e0b; /* Gold for Sheriff */
            --secondary: #10b981; /* Green for Success */
            --danger: #ef4444; /* Red for Caught */
            --card-bg: #1f2937;
            --text: #f3f4f6;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background: var(--bg-dark); color: var(--text);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-image: radial-gradient(circle at 50% 50%, #374151 0%, #111827 100%);
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; position: absolute; top: 0; left: 0; overflow-y: auto; padding: 15px; }
        .active { display: flex; }

        /* UI Elements */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .btn-main {
            background: linear-gradient(135deg, var(--primary), #d97706);
            color: black; border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: 900; border-radius: 12px;
            cursor: pointer; width: 100%; max-width: 300px;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.98); }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹) */
        .goods-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-bottom: 20px; }
        .good-card {
            background: var(--card-bg); border: 2px solid #374151; border-radius: 10px;
            padding: 10px; text-align: center; cursor: pointer; position: relative;
            height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .good-card.selected { border-color: var(--primary); background: rgba(245, 158, 11, 0.1); transform: translateY(-5px); }
        .good-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .good-name { font-size: 0.8rem; font-weight: bold; }
        .good-val { font-size: 0.7rem; color: #9ca3af; }
        .good-illegal { color: var(--danger); }

        /* --- 1. Landing --- */
        #scr-landing { justify-content: center; text-align: center; }
        #scr-landing h1 { font-size: 4rem; margin-bottom: 0; color: var(--primary); }
        
        /* --- 2. TV Screen --- */
        #scr-tv { padding-top: 20px; }
        .tv-header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 15px; margin-bottom: 20px;
        }
        .sheriff-badge { font-size: 2rem; }
        
        .players-status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; width: 100%; }
        .p-stat-card { background: #1f2937; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #374151; position: relative; overflow: hidden; }
        .p-stat-score { font-size: 1.5rem; font-weight: 900; color: var(--primary); }
        
        /* Bag Reveal Animation Area */
        #tv-action-area { 
            margin-top: 30px; width: 100%; flex-grow: 1; display: flex; 
            justify-content: center; align-items: center; flex-direction: column;
        }
        .bag-reveal { font-size: 8rem; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }

        /* --- 3. Player Screen --- */
        #scr-player { max-width: 600px; margin: 0 auto; }
        .role-header { 
            width: 100%; text-align: center; padding: 15px; margin-bottom: 20px; 
            border-radius: 15px; background: rgba(0,0,0,0.3);
        }
        
        /* Smuggler UI */
        .declaration-box { 
            background: #1f2937; padding: 20px; border-radius: 15px; width: 100%; 
            text-align: center; display: none; border: 1px solid var(--primary);
        }
        
        /* Sheriff UI */
        .inspection-list { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .inspect-row { 
            background: #1f2937; padding: 15px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .inspect-actions button { margin-left: 5px; padding: 8px 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-pass { background: var(--secondary); color: white; }
        .btn-inspect { background: var(--danger); color: white; }

        /* --- 4. Admin --- */
        #scr-admin { padding: 20px; }
        .admin-panel { background: #1f2937; padding: 20px; border-radius: 15px; width: 100%; }

        /* Alerts */
        #overlay-result {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #res-emoji { font-size: 6rem; margin-bottom: 10px; }
        #res-title { font-size: 3rem; margin: 0; font-weight: 900; }
        #res-desc { font-size: 1.5rem; color: #ccc; }

    </style>
</head>
<body>

    <div id="overlay-result">
        <div id="res-emoji">ğŸ‘®â€â™‚ï¸</div>
        <div id="res-title">ØªÙ… Ø§Ù„ØªÙØªÙŠØ´!</div>
        <div id="res-desc">...</div>
    </div>

    <div id="scr-landing" class="screen active">
        <div style="font-size:5rem;">ğŸ‘®â€â™‚ï¸ğŸ“¦</div>
        <h1>Ø¬Ù…Ø§Ø±Ùƒ</h1>
        <p style="color:#9ca3af; margin-bottom:30px;">ØªØ­Ø¯ÙŠ Ø§Ù„ØªÙ‡Ø±ÙŠØ¨ ÙˆØ§Ù„ØªÙØªÙŠØ´</p>
        <button class="btn-main" onclick="setupGame()">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù‚Ø·Ø© ØªÙØªÙŠØ´ ğŸš§</button>
    </div>

    <div id="scr-connect" class="screen">
        <h2 style="color:var(--primary)">Ø§Ù†Ø¶Ù… Ù„Ù„Ù†Ù‚Ø·Ø©</h2>
        <div style="background:white; padding:15px; border-radius:15px; margin:20px 0;" id="qr-box"></div>
        <button class="btn-main" onclick="goTV()">ÙØªØ­ Ø§Ù„Ø´Ø§Ø´Ø© ğŸ“º</button>
        <div id="lobby-players-list" style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>
        <div id="admin-controls-lobby" style="display:none; width:100%; margin-top:20px;">
            <button class="btn-main" style="background:#10b981; color:white;" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±)</button>
        </div>
    </div>

    <div id="scr-tv" class="screen">
        <div class="tv-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="sheriff-badge">ğŸ‘®â€â™‚ï¸</span>
                <div>
                    <div style="font-size:0.8rem; color:#9ca3af;">Ø§Ù„Ù…ÙØªØ´ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                    <div style="font-weight:bold; font-size:1.2rem;" id="tv-sheriff-name">...</div>
                </div>
            </div>
            <div style="background:#374151; padding:5px 15px; border-radius:20px; font-weight:bold;" id="tv-phase">Ø§Ù†ØªØ¸Ø§Ø±...</div>
        </div>

        <div id="tv-players-grid" class="players-status-grid"></div>

        <div id="tv-action-area">
            <div style="font-size:2rem; color:#6b7280;">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙØªÙŠØ´</div>
        </div>
    </div>

    <div id="scr-player" class="screen">
        <div id="login-form" style="text-align:center; width:100%; margin-top:50px;">
            <h2>Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙŠØ§ Ù…Ù‡Ø±Ø¨ ğŸ•µï¸</h2>
            <input type="text" id="p-name" placeholder="Ø§Ø³Ù…Ùƒ" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:none; text-align:center;">
            <button class="btn-main" onclick="joinGame()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="game-interface" style="display:none; width:100%;">
            <div class="role-header" id="role-display">
                <div style="font-size:2rem;" id="role-icon">ğŸ“¦</div>
                <h2 style="margin:5px 0;" id="role-text">Ø£Ù†Øª Ù…Ù‡Ø±Ø¨</h2>
                <div style="font-size:0.9rem; color:var(--primary);">Ù†Ù‚Ø§Ø·Ùƒ: <span id="my-score">0</span></div>
            </div>

            <div id="smuggler-ui" style="display:none;">
                <h3 style="margin-bottom:10px;">Ø§Ø®ØªØ± Ø¨Ø¶Ø§Ø¹ØªÙƒ (Ø§Ù„Ø´Ù†Ø·Ø©)</h3>
                <div class="goods-grid" id="my-hand"></div>
                <button id="btn-prepare-bag" class="btn-main" onclick="showDeclaration()">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø´Ù†Ø·Ø© ğŸ’¼</button>

                <div id="declaration-ui" class="declaration-box">
                    <h3>Ù…Ø§Ø°Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ø´Ù†Ø·ØªÙƒØŸ</h3>
                    <p style="color:#9ca3af; font-size:0.9rem;">(Ø£Ø®Ø¨Ø± Ø§Ù„Ù…ÙØªØ´ Ø¨Ù…Ø§ ØªØ±ÙŠØ¯ØŒ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ°Ø¨)</p>
                    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:20px;">
                        <input type="number" id="decl-count" value="1" min="1" max="5" style="width:60px; padding:10px; text-align:center; border-radius:8px; border:none;">
                        <select id="decl-type" style="padding:10px; border-radius:8px; border:none; width:150px;">
                            <option value="apple">ğŸ ØªÙØ§Ø­ (Ø­Ù„Ø§Ù„)</option>
                            <option value="bread">ğŸ¥– Ø®Ø¨Ø² (Ø­Ù„Ø§Ù„)</option>
                            <option value="chicken">ğŸ— Ø¯Ø¬Ø§Ø¬ (Ø­Ù„Ø§Ù„)</option>
                        </select>
                    </div>
                    <button class="btn-main" onclick="submitBag()">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø´Ù†Ø·Ø© Ù„Ù„Ù…ÙØªØ´ ğŸš€</button>
                    <button style="background:transparent; border:none; color:#9ca3af; margin-top:10px;" onclick="cancelDeclaration()">ØªØ±Ø§Ø¬Ø¹</button>
                </div>
                
                <div id="waiting-msg" style="text-align:center; display:none; margin-top:20px;">
                    <h3>ğŸ’¼ Ø§Ù„Ø´Ù†Ø·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙØªØ´...</h3>
                    <p>ÙŠØ§ Ø±Ø¨ ØªØ¹Ø¯ÙŠ...</p>
                </div>
            </div>

            <div id="sheriff-ui" style="display:none;">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡Ù…</h3>
                <div id="inspection-list" class="inspection-list"></div>
                <div id="no-suspects" style="text-align:center; color:#6b7280; margin-top:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙØªÙŠØ´ Ø¨Ø¹Ø¯...</div>
            </div>
        </div>
    </div>

    <div id="scr-admin" class="screen">
        <div class="admin-panel">
            <h2>Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <button class="btn-main" style="margin-bottom:10px;" onclick="nextRound()">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© / ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ´</button>
            <button class="btn-main" style="background:#ef4444;" onclick="fullReset()">ØªØµÙÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDh4v9gRCICA_XRCJXsDpbtCySYAoFsfhk",
            authDomain: "bagera-word.firebaseapp.com",
            databaseURL: "https://bagera-word-default-rtdb.firebaseio.com",
            projectId: "bagera-word",
            storageBucket: "bagera-word.firebasestorage.app",
            messagingSenderId: "53001885470",
            appId: "1:53001885470:web:c6649f9f259824f747db0f"
        };
        try { if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig); else firebase.app(); } catch(e) {}
        const db = firebase.database();

        // --- Game Data ---
        const GOODS = {
            apple: { name: "ØªÙØ§Ø­", icon: "ğŸ", val: 10, type: "legal" },
            bread: { name: "Ø®Ø¨Ø²", icon: "ğŸ¥–", val: 10, type: "legal" },
            chicken: { name: "Ø¯Ø¬Ø§Ø¬", icon: "ğŸ—", val: 20, type: "legal" },
            diamond: { name: "Ø§Ù„Ù…Ø§Ø³Ø©", icon: "ğŸ’", val: 60, type: "illegal", penalty: 30 },
            gun: { name: "Ø³Ù„Ø§Ø­", icon: "ğŸ”«", val: 80, type: "illegal", penalty: 40 }
        };
        const DECK = ['apple','apple','apple','bread','bread','chicken','chicken','diamond','gun','apple','bread'];

        let roomId = new URLSearchParams(window.location.search).get('room');
        let myId = localStorage.getItem('jamarek_uid') || Date.now().toString();
        localStorage.setItem('jamarek_uid', myId);
        let myRole = ''; // 'sheriff' or 'smuggler'
        let myHand = [];
        let selectedCards = [];

        // --- Init ---
        window.onload = function() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const mode = new URLSearchParams(window.location.search).get('mode');
            
            if(mode === 'tv') {
                document.getElementById('scr-tv').classList.add('active');
                initTV();
            } else if(roomId) {
                // Check if admin
                db.ref(`jamarek/${roomId}`).once('value', snap => {
                    if(snap.exists()) {
                        // Check if I am already registered
                        if(localStorage.getItem('jamarek_joined_' + roomId)) {
                            document.getElementById('scr-player').classList.add('active');
                            document.getElementById('login-form').style.display = 'none';
                            document.getElementById('game-interface').style.display = 'block';
                            initPlayer();
                        } else {
                            document.getElementById('scr-player').classList.add('active');
                        }
                        
                        // Show admin controls if creator
                        if(snap.val().creator === myId) {
                            // Can add special admin button here if needed
                        }
                    } else {
                        // Room doesn't exist or just created
                        document.getElementById('scr-connect').classList.add('active');
                        initLobby();
                    }
                });
            } else {
                document.getElementById('scr-landing').classList.add('active');
            }
        };

        // --- Core ---
        function setupGame() {
            roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            db.ref(`jamarek/${roomId}`).set({
                state: 'lobby',
                creator: myId,
                round: 1
            }).then(() => {
                window.location.href = `?room=${roomId}&role=admin`;
            });
        }

        function goTV() {
            window.open(`?room=${roomId}&mode=tv`, '_blank');
        }

        // --- Lobby ---
        function initLobby() {
            const url = window.location.href.split('?')[0] + `?room=${roomId}`;
            document.getElementById('qr-box').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}" style="width:100%">`;
            document.getElementById('admin-controls-lobby').style.display = 'block';

            db.ref(`jamarek/${roomId}/players`).on('value', snap => {
                const div = document.getElementById('lobby-players-list');
                div.innerHTML = '';
                if(snap.val()) {
                    Object.values(snap.val()).forEach(p => {
                        div.innerHTML += `<div style="background:#374151; padding:5px 15px; border-radius:20px;">${p.name}</div>`;
                    });
                }
            });
        }

        function startGame() {
            // Assign Sheriff (Random)
            db.ref(`jamarek/${roomId}/players`).once('value', snap => {
                const players = snap.val();
                if(!players) return;
                const ids = Object.keys(players);
                const sheriffId = ids[Math.floor(Math.random() * ids.length)];
                
                let updates = {};
                updates[`jamarek/${roomId}/state`] = 'playing';
                updates[`jamarek/${roomId}/sheriff`] = sheriffId;
                
                // Reset hands
                ids.forEach(id => {
                    const hand = [];
                    for(let i=0; i<5; i++) hand.push(DECK[Math.floor(Math.random()*DECK.length)]);
                    updates[`jamarek/${roomId}/players/${id}/hand`] = hand;
                    updates[`jamarek/${roomId}/players/${id}/status`] = 'thinking'; // thinking, ready, passed, inspected
                    updates[`jamarek/${roomId}/players/${id}/bag`] = null;
                });

                db.ref().update(updates);
                document.getElementById('scr-connect').classList.remove('active');
                // Redirect admin to player screen if they are playing
                document.getElementById('scr-player').classList.add('active');
                initPlayer();
            });
        }

        // --- Player ---
        function joinGame() {
            const name = document.getElementById('p-name').value;
            if(!name) return;
            
            db.ref(`jamarek/${roomId}/players/${myId}`).set({
                name: name,
                score: 0
            }).then(() => {
                localStorage.setItem('jamarek_joined_' + roomId, 'true');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('game-interface').style.display = 'block';
                initPlayer();
            });
        }

        function initPlayer() {
            db.ref(`jamarek/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                const me = data.players[myId];
                if(!me) return; // Kicked or error

                document.getElementById('my-score').innerText = me.score || 0;

                // Determine Role
                if(data.sheriff === myId) {
                    myRole = 'sheriff';
                    document.getElementById('role-icon').innerText = 'ğŸ‘®â€â™‚ï¸';
                    document.getElementById('role-text').innerText = 'Ø£Ù†Øª Ø§Ù„Ù…ÙØªØ´';
                    document.getElementById('smuggler-ui').style.display = 'none';
                    document.getElementById('sheriff-ui').style.display = 'block';
                    renderSheriffView(data.players);
                } else {
                    myRole = 'smuggler';
                    document.getElementById('role-icon').innerText = 'ğŸ§³';
                    document.getElementById('role-text').innerText = 'Ø£Ù†Øª Ù…Ù‡Ø±Ø¨';
                    document.getElementById('sheriff-ui').style.display = 'none';
                    document.getElementById('smuggler-ui').style.display = 'block';
                    
                    if(me.status === 'ready') {
                        document.getElementById('waiting-msg').style.display = 'block';
                        document.getElementById('my-hand').style.display = 'none';
                        document.getElementById('btn-prepare-bag').style.display = 'none';
                    } else if (me.status === 'thinking') {
                        document.getElementById('waiting-msg').style.display = 'none';
                        document.getElementById('my-hand').style.display = 'grid';
                        document.getElementById('btn-prepare-bag').style.display = 'block';
                        myHand = me.hand || [];
                        renderHand();
                    }
                }
            });
        }

        function renderHand() {
            const grid = document.getElementById('my-hand');
            if(grid.innerHTML && selectedCards.length > 0) return; // Don't redraw if selecting
            grid.innerHTML = '';
            
            myHand.forEach((item, idx) => {
                const info = GOODS[item];
                grid.innerHTML += `
                <div class="good-card ${info.type === 'illegal' ? 'good-illegal' : ''}" onclick="toggleCard(this, '${item}', ${idx})">
                    <div class="good-icon">${info.icon}</div>
                    <div class="good-name">${info.name}</div>
                    <div class="good-val">${info.val}Ù†</div>
                </div>`;
            });
        }

        function toggleCard(el, item, idx) {
            if(el.classList.contains('selected')) {
                el.classList.remove('selected');
                selectedCards = selectedCards.filter(c => c.idx !== idx);
            } else {
                if(selectedCards.length >= 5) return alert("Ø§Ù„Ø´Ù†Ø·Ø© Ù…Ù„ÙŠØ§Ù†Ø©!");
                el.classList.add('selected');
                selectedCards.push({item, idx});
            }
        }

        function showDeclaration() {
            if(selectedCards.length === 0) return alert("Ø§Ø®ØªØ± Ø¨Ø¶Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹!");
            document.getElementById('my-hand').style.display = 'none';
            document.getElementById('btn-prepare-bag').style.display = 'none';
            document.getElementById('declaration-ui').style.display = 'block';
            document.getElementById('decl-count').value = selectedCards.length;
        }

        function cancelDeclaration() {
            document.getElementById('declaration-ui').style.display = 'none';
            document.getElementById('my-hand').style.display = 'grid';
            document.getElementById('btn-prepare-bag').style.display = 'block';
        }

        function submitBag() {
            const count = document.getElementById('decl-count').value;
            const type = document.getElementById('decl-type').value;
            const declaration = `${count} ${GOODS[type].name}`;
            
            const bagItems = selectedCards.map(c => c.item);

            db.ref(`jamarek/${roomId}/players/${myId}`).update({
                bag: bagItems,
                declaration: declaration,
                declaredType: type, // Store what they claimed it is
                status: 'ready'
            });

            document.getElementById('declaration-ui').style.display = 'none';
            selectedCards = [];
        }

        // --- Sheriff Logic ---
        function renderSheriffView(players) {
            const list = document.getElementById('inspection-list');
            list.innerHTML = '';
            let hasSuspects = false;

            Object.keys(players).forEach(pid => {
                if(pid === myId) return; // Don't inspect self
                const p = players[pid];
                
                if(p.status === 'ready') {
                    hasSuspects = true;
                    list.innerHTML += `
                    <div class="inspect-row">
                        <div>
                            <div style="font-weight:bold; color:var(--primary);">${p.name}</div>
                            <div style="font-size:0.9rem;">ÙŠÙ‚ÙˆÙ„: "Ù…Ø¹ÙŠ ${p.declaration}"</div>
                        </div>
                        <div class="inspect-actions">
                            <button class="btn-pass" onclick="decide('${pid}', 'pass')">ğŸ¤ ØªÙ…Ø´ÙŠØ©</button>
                            <button class="btn-inspect" onclick="decide('${pid}', 'inspect')">ğŸ” ØªÙØªÙŠØ´</button>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('no-suspects').style.display = hasSuspects ? 'none' : 'block';
        }

        function decide(pid, action) {
            // Logic handled by Sheriff client for now (secure enough for MVP)
            db.ref(`jamarek/${roomId}/players/${pid}`).once('value', snap => {
                const p = snap.val();
                const bag = p.bag;
                const declaredType = p.declaredType;
                
                let isLie = false;
                let bagValue = 0;
                let penalty = 0;

                bag.forEach(item => {
                    const info = GOODS[item];
                    bagValue += info.val;
                    if(item !== declaredType || info.type === 'illegal') {
                        isLie = true;
                        if(info.type === 'illegal') penalty += info.penalty;
                        else penalty += 10; // Simple penalty for wrong legal item
                    }
                });

                let updates = {};
                let resultMsg = "";
                let resultEmoji = "";

                if(action === 'pass') {
                    // Smuggler gets full value
                    updates[`jamarek/${roomId}/players/${pid}/score`] = (p.score || 0) + bagValue;
                    updates[`jamarek/${roomId}/players/${pid}/status`] = 'passed';
                    resultMsg = `${p.name} Ø¹Ø¨Ø± Ø¨Ø³Ù„Ø§Ù…!`;
                    resultEmoji = "ğŸ¤";
                } else {
                    // Inspect
                    if(isLie) {
                        // Caught! Smuggler pays penalty, Sheriff gets penalty value
                        updates[`jamarek/${roomId}/players/${pid}/score`] = (p.score || 0) - penalty;
                        updates[`jamarek/${roomId}/players/${myId}/score`] = (p.score || 0) + penalty; // Sheriff bonus
                        updates[`jamarek/${roomId}/players/${pid}/status`] = 'inspected_caught';
                        resultMsg = `ØªÙ… ÙƒØ´Ù ${p.name}! Ù…Ù‡Ø±Ø¨ ÙƒØ°Ø§Ø¨!`;
                        resultEmoji = "ğŸš¨";
                    } else {
                        // Innocent! Sheriff pays penalty to Smuggler
                        const compensation = 20; // Fixed compensation
                        updates[`jamarek/${roomId}/players/${pid}/score`] = (p.score || 0) + bagValue + compensation;
                        updates[`jamarek/${roomId}/players/${myId}/score`] = (p.score || 0) - compensation;
                        updates[`jamarek/${roomId}/players/${pid}/status`] = 'inspected_clean';
                        resultMsg = `${p.name} ÙƒØ§Ù† ØµØ§Ø¯Ù‚! Ø§Ù„Ù…ÙØªØ´ ØªÙˆØ±Ø·.`;
                        resultEmoji = "âœ…";
                    }
                }

                updates[`jamarek/${roomId}/lastAction`] = {
                    msg: resultMsg,
                    emoji: resultEmoji,
                    timestamp: Date.now()
                };

                db.ref().update(updates);
            });
        }

        // --- TV Logic ---
        function initTV() {
            db.ref(`jamarek/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                // Update Sheriff Name
                if(data.players && data.sheriff) {
                    document.getElementById('tv-sheriff-name').innerText = data.players[data.sheriff].name;
                }

                // Render Players Status
                const grid = document.getElementById('tv-players-grid');
                grid.innerHTML = '';
                if(data.players) {
                    Object.values(data.players).forEach(p => {
                        let statusIcon = "ğŸ¤”";
                        if(p.status === 'ready') statusIcon = "ğŸ’¼";
                        if(p.status === 'passed') statusIcon = "âœ…";
                        if(p.status === 'inspected_caught') statusIcon = "ğŸš«";
                        if(p.status === 'inspected_clean') statusIcon = "ğŸ˜‡";

                        grid.innerHTML += `
                        <div class="p-stat-card">
                            <div style="color:#9ca3af;">${p.name}</div>
                            <div style="font-size:2rem;">${statusIcon}</div>
                            <div class="p-stat-score">${p.score || 0}</div>
                        </div>`;
                    });
                }

                // Show Action Result
                if(data.lastAction && (Date.now() - data.lastAction.timestamp < 5000)) {
                    const overlay = document.getElementById('overlay-result');
                    document.getElementById('res-emoji').innerText = data.lastAction.emoji;
                    document.getElementById('res-desc').innerText = data.lastAction.msg;
                    overlay.style.display = 'flex';
                    setTimeout(() => overlay.style.display = 'none', 4000);
                }
            });
        }

        function nextRound() {
            // Logic to rotate sheriff and reset status
            db.ref(`jamarek/${roomId}/players`).once('value', snap => {
                const players = snap.val();
                const ids = Object.keys(players);
                // Rotate sheriff logic here or Random
                const newSheriff = ids[Math.floor(Math.random() * ids.length)];
                
                let updates = {};
                updates[`jamarek/${roomId}/sheriff`] = newSheriff;
                ids.forEach(id => {
                    const hand = [];
                    for(let i=0; i<5; i++) hand.push(DECK[Math.floor(Math.random()*DECK.length)]);
                    updates[`jamarek/${roomId}/players/${id}/hand`] = hand;
                    updates[`jamarek/${roomId}/players/${id}/status`] = 'thinking';
                    updates[`jamarek/${roomId}/players/${id}/bag`] = null;
                    updates[`jamarek/${roomId}/players/${id}/declaration`] = null;
                });
                db.ref().update(updates);
            });
        }

        function fullReset() {
            db.ref(`jamarek/${roomId}`).update({ state: 'lobby' });
        }

    </script>
</body>
</html>
