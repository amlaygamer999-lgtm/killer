<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        :root {
            --bg-color: #f1c40f; 
            --primary: #2c3e50;
            --accent: #e74c3c;
            --success: #27ae60;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            text-align: center;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            width: 80%;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--accent); }

        input {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            width: 70%;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
        }

        .screen { display: none; }
        .active-screen { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .player-card {
            background: #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .goods-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .good-item {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
        }

        .good-item.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .qr-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .status-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
        }
        .status-wait { background: #95a5a6; }
        .status-ready { background: #27ae60; }

    </style>
</head>
<body>

    <div class="container">
        <div id="screen-login" class="screen active-screen">
            <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ ğŸ‘®â€â™‚ï¸</h1>
            <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</p>
            <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
            <br>
            <button class="btn" id="joinBtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>

        <div id="screen-lobby" class="screen">
            <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1>
            <p>Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡:</p>
            <div id="qrcode" class="qr-container"></div>
            
            <h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† (<span id="player-count">0</span>):</h3>
            <div id="lobby-list" style="text-align: right; margin-bottom: 20px;"></div>
            
            <div id="host-controls" style="display:none;">
                <p style="color:red; font-size:12px;">*Ø£Ù†Øª Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ (Ø§Ù„Ù…Ø¶ÙŠÙ)ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</p>
                <button class="btn btn-green" id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <p id="wait-msg">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p>
        </div>

        <div id="screen-selection" class="screen">
            <h2>ğŸ“¦ Ø­Ù‚ÙŠØ¨ØªÙƒ</h2>
            <p id="role-desc">Ø£Ù†Øª Ù…Ø³Ø§ÙØ±ØŒ Ø§Ø®ØªØ± 5 Ø¨Ø¶Ø§Ø¦Ø¹:</p>
            <div class="goods-grid" id="goods-container"></div>
            <p>Ø§Ø®ØªØ±Øª: <span id="selection-count">0</span> / 5</p>
            <button class="btn btn-green" id="confirmSelectionBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©</button>
        </div>

        <div id="screen-waiting-officer" class="screen">
            <h2>â³ Ø§Ù†ØªØ¸Ø±...</h2>
            <p>Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¢Ù†!</p>
            <div class="loader">ğŸ‘®â€â™‚ï¸</div>
        </div>

        <div id="screen-officer" class="screen">
            <h1>ğŸ‘®â€â™‚ï¸ Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´</h1>
            <p>Ø£Ù†Øª Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ! Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹ Ù„ØªÙØªÙŠØ´Ù‡:</p>
            <div id="officer-targets"></div>
        </div>

        <div id="screen-result" class="screen">
            <h1>ğŸ“„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©</h1>
            <div id="result-content"></div>
            <br>
            <div id="officer-next-controls" style="display:none;">
                <button class="btn" id="nextRoundBtn">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
            </div>
            <p id="waiting-next-round" style="display:none;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©...</p>
        </div>
        
        <div id="scoreboard-area" style="display:none; margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
            <h3>ğŸ’° Ø§Ù„Ø£Ø±ØµØ¯Ø©</h3>
            <div id="live-scoreboard"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ---
        const firebaseConfig = {
            apiKey: "AIzaSyDh4v9gRCICA_XRCJXsDpbtCySYAoFsfhk",
            authDomain: "bagera-word.firebaseapp.com",
            databaseURL: "https://bagera-word-default-rtdb.firebaseio.com",
            projectId: "bagera-word",
            storageBucket: "bagera-word.firebasestorage.app",
            messagingSenderId: "53001885470",
            appId: "1:53001885470:web:c6649f9f259824f747db0f"
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ---
        let myId = localStorage.getItem('game_userId');
        if (!myId) {
            myId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('game_userId', myId);
        }
        
        let myName = "";
        let currentRole = ""; // 'officer' or 'traveler'
        let mySelection = [];
        const GOODS = [
            { name: "ğŸ§€ Ø¬Ø¨Ù†", type: "legal", id: "cheese" },
            { name: "ğŸ¥š Ø¨ÙŠØ¶", type: "legal", id: "eggs" },
            { name: "ğŸ¥› Ø­Ù„ÙŠØ¨", type: "legal", id: "milk" },
            { name: "ğŸ¥› Ù„Ø¨Ù†", type: "legal", id: "laban" },
            { name: "ğŸ¾ Ø®Ù…Ø± (Ù…Ù…Ù†ÙˆØ¹)", type: "illegal", id: "alcohol" },
            { name: "ğŸ’Š Ù…Ø®Ø¯Ø±Ø§Øª (Ù…Ù…Ù†ÙˆØ¹)", type: "illegal", id: "drugs" },
            { name: "ğŸ”« Ø£Ø³Ù„Ø­Ø© (Ù…Ù…Ù†ÙˆØ¹)", type: "illegal", id: "weapon" }
        ];

        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        const screens = {
            login: document.getElementById('screen-login'),
            lobby: document.getElementById('screen-lobby'),
            selection: document.getElementById('screen-selection'),
            waitingOfficer: document.getElementById('screen-waiting-officer'),
            officer: document.getElementById('screen-officer'),
            result: document.getElementById('screen-result')
        };

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active-screen'));
            screens[name].classList.add('active-screen');
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù„ÙˆØ¨ÙŠ ---
        
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        new QRCode(document.getElementById("qrcode"), {
            text: window.location.href,
            width: 128,
            height: 128
        });

        document.getElementById('joinBtn').addEventListener('click', () => {
            const name = document.getElementById('username').value.trim();
            if (!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ!');
            myName = name;
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const playerRef = ref(db, 'game/players/' + myId);
            set(playerRef, {
                name: name,
                money: 50,
                status: 'ready',
                isOfficer: false
            }).then(() => {
                showScreen('lobby');
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ø§Ù„Ø£ÙˆÙ„ (Ù„Ø£ÙƒÙˆÙ† Ø§Ù„Ù…Ø¶ÙŠÙ)
                checkIfHost();
            });
        });

        function checkIfHost() {
            get(ref(db, 'game/players')).then((snapshot) => {
                const players = snapshot.val() || {};
                const ids = Object.keys(players);
                // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø¯Ø®Ù„ØªØŒ ØªØ¸Ù‡Ø± Ù„ÙŠ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
                if (ids[0] === myId) {
                    document.getElementById('host-controls').style.display = 'block';
                    document.getElementById('wait-msg').style.display = 'none';
                }
            });
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            update(ref(db, 'game'), {
                state: 'selecting',
                round: 1,
                officerIndex: 0 // Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ùˆ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ
            });
        });

        // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø­Ø±Ùƒ) ---
        onValue(ref(db, 'game'), (snapshot) => {
            const gameData = snapshot.val();
            if (!gameData) return; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯

            const players = gameData.players || {};
            const playerList = Object.keys(players).map(k => ({...players[k], id: k}));
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ
            document.getElementById('player-count').innerText = playerList.length;
            document.getElementById('lobby-list').innerHTML = playerList.map(p => 
                `<div class="player-card"><span>${p.name}</span> <span class="status-badge status-ready">Ù…ØªØµÙ„</span></div>`
            ).join('');

            // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¯Ø§Ø¦Ù…Ø§Ù‹
            document.getElementById('scoreboard-area').style.display = 'block';
            document.getElementById('live-scoreboard').innerHTML = playerList.map(p => 
                `<div style="display:flex; justify-content:space-between; font-size:14px; margin:5px 0;">
                    <span>${p.isOfficer ? 'ğŸ‘®â€â™‚ï¸' : 'ğŸ‘¤'} ${p.name}</span>
                    <span style="color:${p.money < 0 ? 'red' : 'green'}">${p.money} Ø±ÙŠØ§Ù„</span>
                </div>`
            ).join('');

            // --- Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ---
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©
            const sortedIds = Object.keys(players).sort(); // ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª
            const officerId = sortedIds[gameData.officerIndex % sortedIds.length];
            const amIOfficer = (myId === officerId);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
            if (players[myId] && players[myId].isOfficer !== amIOfficer) {
                update(ref(db, 'game/players/' + myId), { isOfficer: amIOfficer });
            }

            // 1. Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹
            if (gameData.state === 'selecting') {
                if (amIOfficer) {
                    showScreen('waitingOfficer');
                    document.querySelector('#screen-waiting-officer h2').innerText = "Ø£Ù†Øª Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ğŸ‘®â€â™‚ï¸";
                    document.querySelector('#screen-waiting-officer p').innerText = "Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ù‡Ø±Ø¨ÙˆÙ† Ø¨Ø¶Ø§Ø¦Ø¹Ù‡Ù…...";
                } else {
                    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³Ø§ÙØ± ÙˆÙ„Ù… Ø§Ø®ØªØ± Ø¨Ø¹Ø¯
                    if (players[myId].hasSelected) {
                        showScreen('waitingOfficer');
                        document.querySelector('#screen-waiting-officer h2').innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…";
                        document.querySelector('#screen-waiting-officer p').innerText = "Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ± Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ...";
                    } else {
                        showScreen('selection');
                        renderGoods();
                    }
                }
            }

            // 2. Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØªÙŠØ´ (Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ÙŠØ®ØªØ§Ø±)
            else if (gameData.state === 'inspecting') {
                if (amIOfficer) {
                    showScreen('officer');
                    renderOfficerTargets(players, myId);
                } else {
                    showScreen('waitingOfficer');
                    document.querySelector('#screen-waiting-officer h2').innerText = "ğŸ” ØªÙØªÙŠØ´!";
                    document.querySelector('#screen-waiting-officer p').innerText = "Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ÙŠØ®ØªØ§Ø± Ø¶Ø­ÙŠØ© Ø§Ù„Ø¢Ù†...";
                }
            }

            // 3. Ø­Ø§Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
            else if (gameData.state === 'result') {
                showScreen('result');
                document.getElementById('result-content').innerHTML = gameData.lastResultHtml || "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©";
                
                if (amIOfficer) {
                    document.getElementById('officer-next-controls').style.display = 'block';
                    document.getElementById('waiting-next-round').style.display = 'none';
                } else {
                    document.getElementById('officer-next-controls').style.display = 'none';
                    document.getElementById('waiting-next-round').style.display = 'block';
                }
            }
        });

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨ ---

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
        function renderGoods() {
            const container = document.getElementById('goods-container');
            if (container.innerHTML !== '') return; // ØªÙ… Ø§Ù„Ø±Ø³Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹
            
            container.innerHTML = '';
            GOODS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'good-item ' + (item.type === 'illegal' ? 'illegal' : '');
                div.innerText = item.name;
                div.onclick = () => selectItem(item, div);
                container.appendChild(div);
            });
        }

        function selectItem(item, div) {
            if (mySelection.length >= 5) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ø¨Ø¶Ø§Ø¦Ø¹!");
            
            mySelection.push(item);
            div.style.background = '#2c3e50';
            div.style.color = 'white';
            
            document.getElementById('selection-count').innerText = mySelection.length;
            if (mySelection.length === 5) {
                document.getElementById('confirmSelectionBtn').disabled = false;
            }
        }

        document.getElementById('confirmSelectionBtn').addEventListener('click', () => {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹ Ù„Ù„Ø³ÙŠØ±ÙØ±
            update(ref(db, 'game/players/' + myId), {
                hand: mySelection,
                hasSelected: true
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ (Ù…Ù†Ø·Ù‚ Ù…Ø¨Ø³Ø·: Ù†Ù†ØªÙ‚Ù„ Ù„Ù„ØªÙØªÙŠØ´ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠØŒ Ù‡Ù†Ø§ Ø³Ù†Ø¬Ø¹Ù„Ù‡ ÙÙˆØ±ÙŠØ§Ù‹)
            // Ø³Ù†Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.
            // **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø· Ù†Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø£Ùˆ Ù†Ø¬Ø¹Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©.
            // Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ØŒ Ø³Ù†Ø¬Ø¹Ù„ Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ ÙŠØ®ØªØ§Ø± Ù‡Ùˆ Ù…Ù† ÙŠÙ‚Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙØªÙŠØ´.
            get(ref(db, 'game/players')).then(snap => {
                const all = Object.values(snap.val());
                const smugglers = all.filter(p => !p.isOfficer);
                const allSelected = smugglers.every(p => p.hasSelected);
                
                if (allSelected) {
                    update(ref(db, 'game'), { state: 'inspecting' });
                }
            });
        });

        // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ
        function renderOfficerTargets(players, myId) {
            const div = document.getElementById('officer-targets');
            div.innerHTML = '';
            
            Object.keys(players).forEach(pid => {
                const p = players[pid];
                if (pid !== myId) { // Ù„Ø§ ØªÙØªØ´ Ù†ÙØ³Ùƒ
                    const btn = document.createElement('div');
                    btn.className = 'player-card';
                    btn.innerHTML = `
                        <span>ğŸ‘¤ ${p.name}</span>
                        <div>
                            <button class="btn-red" style="padding:5px 10px; font-size:14px;">ØªÙØªÙŠØ´ ğŸ”</button>
                            <button class="btn-green" style="padding:5px 10px; font-size:14px;">ØªÙ…Ø´ÙŠØ© ğŸ‘‹</button>
                        </div>
                    `;
                    
                    // Ø²Ø± Ø§Ù„ØªÙØªÙŠØ´
                    btn.querySelector('.btn-red').onclick = () => performAction(pid, 'inspect', p);
                    // Ø²Ø± Ø§Ù„ØªÙ…Ø´ÙŠØ©
                    btn.querySelector('.btn-green').onclick = () => performAction(pid, 'pass', p);
                    
                    div.appendChild(btn);
                }
            });
        }

        function performAction(targetId, action, targetPlayer) {
            let resultHtml = "";
            let updates = {};
            
            if (action === 'pass') {
                resultHtml = `<h3>ğŸ‘‹ Ø§Ù„Ù…Ø³Ø§ÙØ± ${targetPlayer.name} Ø¹Ø¨Ø± Ø¨Ø³Ù„Ø§Ù…!</h3><p>Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ Ù‚Ø±Ø± Ø¹Ø¯Ù… Ø§Ù„ØªÙØªÙŠØ´.</p>`;
            } else {
                // ØªÙØªÙŠØ´
                const hand = targetPlayer.hand || [];
                let illegalCount = 0;
                let legalCount = 0;
                let details = "";
                
                hand.forEach(item => {
                    if (item.type === 'illegal') {
                        illegalCount++;
                        details += `<span style="color:red">ğŸš« ${item.name}</span> `;
                    } else {
                        legalCount++;
                        details += `<span style="color:green">âœ… ${item.name}</span> `;
                    }
                });
                
                if (illegalCount > 0) {
                    const fine = illegalCount * 10;
                    updates['game/players/' + targetId + '/money'] = targetPlayer.money - fine;
                    updates['game/players/' + myId + '/money'] = (window.myCurrentMoney || 50) + fine; // Ù†Ø­ØªØ§Ø¬ Ù‚Ø±Ø§Ø¡Ø© Ù…Ø§Ù„ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ Ø¨Ø¯Ù‚Ø©ØŒ Ù„ÙƒÙ† Ù„Ù„ØªØ³Ù‡ÙŠÙ„ Ø³Ù†Ø­Ø¯Ø«Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
                    // Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¯Ù‚ Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø§Ù„ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ:
                    get(ref(db, 'game/players/' + myId + '/money')).then(snap => {
                        update(ref(db), { ['game/players/' + myId + '/money']: snap.val() + fine });
                    });
                    
                    resultHtml = `<h3>ğŸš¨ ØªÙ… ÙƒØ´Ù Ù…Ù…Ù†ÙˆØ¹Ø§Øª!</h3><p>Ø§Ù„Ù…Ø³Ø§ÙØ± ${targetPlayer.name} ÙƒØ§Ù† Ù…Ø¹Ù‡: ${details}</p><p>Ø¯ÙØ¹ ØºØ±Ø§Ù…Ø© ${fine} Ø±ÙŠØ§Ù„ Ù„Ù„Ø¬Ù…Ø±ÙƒÙŠ.</p>`;
                } else {
                    const comp = legalCount * 3;
                    updates['game/players/' + targetId + '/money'] = targetPlayer.money + comp;
                    get(ref(db, 'game/players/' + myId + '/money')).then(snap => {
                        update(ref(db), { ['game/players/' + myId + '/money']: snap.val() - comp });
                    });
                    
                    resultHtml = `<h3>âœ… Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø³Ù„ÙŠÙ…Ø©!</h3><p>Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ ØªÙˆØ±Ø· ÙˆØ¯ÙØ¹ ØªØ¹ÙˆÙŠØ¶ ${comp} Ø±ÙŠØ§Ù„ Ù„Ù„Ù…Ø³Ø§ÙØ± ${targetPlayer.name}.</p>`;
                }
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            updates['game/state'] = 'result';
            updates['game/lastResultHtml'] = resultHtml;
            update(ref(db), updates);
        }

        document.getElementById('nextRoundBtn').addEventListener('click', () => {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆÙ„Ø©
            get(ref(db, 'game')).then(snap => {
                const data = snap.val();
                let updates = {};
                updates['game/state'] = 'selecting';
                updates['game/officerIndex'] = data.officerIndex + 1;
                updates['game/lastResultHtml'] = "";
                
                // ØªØµÙÙŠØ± Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                const players = data.players;
                Object.keys(players).forEach(pid => {
                    updates[`game/players/${pid}/hasSelected`] = false;
                    updates[`game/players/${pid}/hand`] = [];
                });
                
                update(ref(db), updates);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ
                mySelection = [];
                document.getElementById('selection-count').innerText = "0";
                document.getElementById('confirmSelectionBtn').disabled = true;
                document.getElementById('goods-container').innerHTML = '';
            });
        });

    </script>
</body>
</html>
